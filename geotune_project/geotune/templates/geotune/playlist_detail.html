{% extends 'geotune/base.html' %}
{% load custom_filters %}

{% block title %}{{ playlist.name }} - GeoTune{% endblock %}

{% block content %}
<div class="playlist-container">
    <!-- Hero Section -->
    <section class="playlist-hero">
        <div class="playlist-hero-content">
            <div class="playlist-title-container">
                <h1 class="playlist-title">{{ playlist.name }}</h1>
                    {% if playlist.ist_oeffentlich %}
                    <span class="playlist-badge public">
                        <i class="fas fa-globe"></i> Öffentlich
                    </span>
                    {% else %}
                    <span class="playlist-badge private">
                        <i class="fas fa-lock"></i> Privat
                    </span>
                    {% endif %}
                </div>
                
            <div class="playlist-meta">
                <div class="playlist-meta-item">
                    <i class="fas fa-user"></i>
                    <a href="{% url 'nutzerprofil' playlist.erstellt_von.id %}">
                        {{ playlist.erstellt_von.username }}
                    </a>
                </div>
                <div class="playlist-meta-item">
                    <i class="far fa-calendar-alt"></i>
                    <span>{{ playlist.erstellungsdatum|date:"d.m.Y" }}</span>
                </div>
                <div class="playlist-meta-item">
                    <i class="fas fa-eye"></i>
                    <span>{{ playlist.anzahl_aufrufe }} Aufrufe</span>
                </div>
                <div class="playlist-meta-item">
                    <i class="fas fa-music"></i>
                    <span>{{ lieder|length }} Lieder</span>
                </div>
            </div>
                
                {% if playlist.beschreibung %}
            <p class="playlist-description">{{ playlist.beschreibung }}</p>
                {% endif %}
                
                {% if playlist.genres.all %}
            <div class="playlist-genres">
                    {% for genre in playlist.genres.all %}
                <span class="genre-tag">{{ genre.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            
            <div class="playlist-actions">
                    {% if playlist.erstellt_von == user %}
                <a href="{% url 'playlist_standort_hinzufuegen' playlist.id %}" class="btn-hero primary">
                    <i class="fas fa-map-marker-alt"></i> Standort hinzufügen
                    </a>
                <a href="#" class="btn-hero edit">
                    <i class="fas fa-edit"></i> Bearbeiten
                    </a>
                    {% endif %}
                    
                <button id="favorite-btn" class="btn-hero accent">
                    <i class="fas fa-star"></i>
                        {% if ist_favorit %}Favorisiert{% else %}Favorisieren{% endif %}
                    </button>
                </div>
            </div>
    </section>

<!-- Main Content -->
    <div class="content-grid">
        <!-- Left Column -->
        <div class="content-main">
            <!-- Songs Section -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-music"></i>
                        <h2>Lieder</h2>
                    </div>
                    
                {% if playlist.erstellt_von == user %}
                    <button type="button" class="btn-action" data-bs-toggle="modal" data-bs-target="#addSongModal">
                        <i class="fas fa-plus"></i>
                        <span>Hinzufügen</span>
                </button>
                {% endif %}
            </div>
            
                {% if lieder %}
                <div class="song-list">
                            {% for playlist_lied in lieder %}
                    <div class="song-item">
                        <div class="song-number">{{ forloop.counter }}</div>
                        
                        <div class="song-cover">
                                        {% if playlist_lied.lied.cover_bild %}
                                <img src="{{ playlist_lied.lied.cover_bild }}" alt="Cover von {{ playlist_lied.lied.titel }}">
                                        {% else %}
                                <div class="song-cover-placeholder">
                                    <i class="fas fa-music"></i>
                                            </div>
                                        {% endif %}
                        </div>
                                        
                        <div class="song-info">
                            <div class="song-title">
                                            {% if playlist_lied.lied.externe_url %}
                                <a href="{{ playlist_lied.lied.externe_url }}" target="_blank" rel="noopener">
                                                    {{ playlist_lied.lied.titel }}
                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            {% else %}
                                                {{ playlist_lied.lied.titel }}
                                            {% endif %}
                                        </div>
                            
                            <div class="song-details">
                                <span class="song-artist">{{ playlist_lied.lied.kuenstler }}</span>
                                {% if playlist_lied.lied.album %}
                                <span class="song-album d-none d-md-inline">{{ playlist_lied.lied.album }}</span>
                                {% endif %}
                                <span class="song-added-by d-none d-md-inline">
                                    Hinzugefügt von 
                                    <a href="{% url 'nutzerprofil' playlist_lied.hinzugefuegt_von.id %}">
                                        {{ playlist_lied.hinzugefuegt_von.username }}
                                    </a>
                                </span>
                            </div>
                        </div>
                        
                        <div class="song-duration">
                            {{ playlist_lied.lied.dauer|intdiv:60 }}:{{ playlist_lied.lied.dauer|modulo:60|stringformat:"02d" }}
                        </div>
                    </div>
                            {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-music"></i>
                    </div>
                    <h3>Keine Lieder</h3>
                    <p>Diese Playlist enthält noch keine Lieder.</p>
                    
                    {% if playlist.erstellt_von == user %}
                    <button type="button" class="btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSongModal">
                        <i class="fas fa-plus"></i> Erstes Lied hinzufügen
                    </button>
                    {% endif %}
                </div>
                {% endif %}
        </div>
        
        <!-- Comments Section -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-comments"></i>
                        <h2>Kommentare</h2>
            </div>
                    </div>
                
                <!-- Comment Form -->
                <div class="comment-form-container">
                    <form id="comment-form" method="post" action="{% url 'kommentar_hinzufuegen' playlist.id %}">
                        {% csrf_token %}
                        <div class="comment-input">
                            <textarea 
                                id="comment-text" 
                                name="text" 
                                placeholder="Schreibe einen Kommentar..."
                                required
                            ></textarea>
                            <button type="submit" class="btn-comment">
                                <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                </div>
                
                <!-- Comments List -->
                <div class="comments-list">
                {% if kommentare %}
                    {% for kommentar in kommentare %}
                        <div class="comment">
                            <div class="comment-avatar">
                            {% if kommentar.nutzer.profilbild %}
                                    <img src="{{ kommentar.nutzer.profilbild.url }}" alt="{{ kommentar.nutzer.username }}">
                            {% else %}
                                    <div class="avatar-placeholder">
                                        {{ kommentar.nutzer.username|first|upper }}
                                </div>
                            {% endif %}
                        </div>
                            
                            <div class="comment-content">
                                <div class="comment-header">
                                    <a href="{% url 'nutzerprofil' kommentar.nutzer.id %}" class="comment-author">
                                        {{ kommentar.nutzer.username }}
                                    </a>
                                    <span class="comment-time">
                                        {{ kommentar.erstellungsdatum|date:"d.m.Y" }} um {{ kommentar.erstellungsdatum|date:"H:i" }}
                                    </span>
                            </div>
                                
                                <div class="comment-text">
                                    {{ kommentar.text }}
                                </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                        <div class="empty-state small">
                            <div class="empty-state-icon">
                                <i class="far fa-comment-dots"></i>
                            </div>
                            <p>Noch keine Kommentare vorhanden.<br>Sei der Erste!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
        <!-- Sidebar -->
        <div class="content-sidebar">
            <!-- Locations Section -->
            <div class="sidebar-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        <h2>Standorte</h2>
            </div>
                    
                    {% if playlist.erstellt_von == user and standorte %}
                    <a href="{% url 'playlist_standort_hinzufuegen' playlist.id %}" class="btn-outline-primary">
                        <i class="fas fa-map-marker-alt"></i> Standort hinzufügen
                    </a>
                    {% endif %}
                </div>
                
                {% if standorte %}
                <div class="map-container">
                    <div id="playlist-map"></div>
                    </div>
                    
                <div class="location-list">
                        {% for ps in standorte %}
                        <div class="location-item">
                        <div class="location-icon">
                            <i class="fas fa-map-pin"></i>
                        </div>
                        
                        <div class="location-details">
                            <div class="location-name">
                                    {% if ps.standort.stadt or ps.standort.land %}
                                    {{ ps.standort.stadt }}{% if ps.standort.stadt and ps.standort.land %}, {% endif %}{{ ps.standort.land }}
                                {% else %}
                                    Unbenannter Standort
                                    {% endif %}
                            </div>
                                    
                                    {% if ps.standort.adresse %}
                            <div class="location-address">{{ ps.standort.adresse }}</div>
                                    {% endif %}
                                    
                            <div class="location-coordinates">
                                {{ ps.standort.breitengrad|floatformat:6 }}, {{ ps.standort.laengengrad|floatformat:6 }}
                            </div>
                                    
                                    {% if ps.standort.beschreibung %}
                            <div class="location-description">
                                "{{ ps.standort.beschreibung }}"
                            </div>
                                    {% endif %}
                                </div>
                        
                        <a 
                            href="https://www.google.com/maps/search/?api=1&query={{ ps.standort.breitengrad }},{{ ps.standort.laengengrad }}" 
                            target="_blank" 
                            rel="noopener"
                            class="location-action"
                            title="In Google Maps öffnen"
                        >
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-map-marker-slash"></i>
                        </div>
                    <h3>Keine Standorte</h3>
                    <p>Diese Playlist hat noch keine Standorte.</p>
                    
                        {% if playlist.erstellt_von == user %}
                    <a href="{% url 'playlist_standort_hinzufuegen' playlist.id %}" class="btn-outline-primary">
                        <i class="fas fa-map-marker-alt"></i> Standort hinzufügen
                        </a>
                        {% endif %}
                    </div>
                {% endif %}
        </div>
        
            <!-- Similar Playlists Section -->
            <div class="sidebar-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-list-music"></i>
                        <h2>Ähnliche Playlists</h2>
            </div>
                </div>
                
                {% if aehnliche_playlists %}
                <div class="similar-playlists">
                        {% for aehnliche_playlist in aehnliche_playlists %}
                    <a href="{% url 'playlist_detail' aehnliche_playlist.id %}" class="similar-playlist">
                        <div class="similar-playlist-icon">
                                    <i class="fas fa-music"></i>
                                </div>
                        
                        <div class="similar-playlist-info">
                            <div class="similar-playlist-name">
                                {{ aehnliche_playlist.name }}
                            </div>
                            <div class="similar-playlist-meta">
                                    <span>{{ aehnliche_playlist.erstellt_von.username }}</span>
                                <span class="meta-separator"></span>
                                    <span>{{ aehnliche_playlist.lieder.count }} Lieder</span>
                            </div>
                        </div>
                        
                        <div class="similar-playlist-action">
                            <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                <div class="empty-state small">
                    <div class="empty-state-icon">
                        <i class="fas fa-music"></i>
                    </div>
                    <p>Keine ähnlichen Playlists gefunden.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Song Modal -->
{% if playlist.erstellt_von == user %}
<div class="modal fade" id="addSongModal" tabindex="-1" aria-labelledby="addSongModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSongModalLabel">Lied zur Playlist hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="{{ lied_form.titel.id_for_label }}" name="{{ lied_form.titel.html_name }}" placeholder="Titel" required>
                        <label for="{{ lied_form.titel.id_for_label }}">Titel</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="{{ lied_form.kuenstler.id_for_label }}" name="{{ lied_form.kuenstler.html_name }}" placeholder="Künstler" required>
                        <label for="{{ lied_form.kuenstler.id_for_label }}">Künstler</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="{{ lied_form.album.id_for_label }}" name="{{ lied_form.album.html_name }}" placeholder="Album">
                                <label for="{{ lied_form.album.id_for_label }}">Album</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="{{ lied_form.dauer.id_for_label }}" name="dauer_format" placeholder="Dauer (MM:SS)" required pattern="^([0-9]{1,2}):([0-5][0-9])$">
                                <input type="hidden" name="{{ lied_form.dauer.html_name }}" id="dauer_sekunden">
                                <label for="{{ lied_form.dauer.id_for_label }}">Dauer (MM:SS)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="{{ lied_form.externe_url.id_for_label }}" name="{{ lied_form.externe_url.html_name }}" placeholder="Externe URL">
                        <label for="{{ lied_form.externe_url.id_for_label }}">Externe URL</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="{{ lied_form.cover_bild.id_for_label }}" name="{{ lied_form.cover_bild.html_name }}" placeholder="Cover Bild URL">
                        <label for="{{ lied_form.cover_bild.id_for_label }}">Cover Bild URL</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-hero edit" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Abbrechen
                    </button>
                    <button type="submit" class="btn-hero accent">
                        <i class="fas fa-plus"></i> Lied hinzufügen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- First, define locations data so it's accessible to our scripts -->
<script>
    // Define locations data from Django template
    window.playlistLocations = [
        {% for ps in standorte %}
        {
            lat: {{ ps.standort.breitengrad }},
            lng: {{ ps.standort.laengengrad }},
            name: "{% if ps.standort.stadt or ps.standort.land %}{{ ps.standort.stadt }}{% if ps.standort.stadt and ps.standort.land %}, {% endif %}{{ ps.standort.land }}{% else %}Standort{% endif %}",
            address: "{{ ps.standort.adresse|escapejs|default:'' }}",
            description: "{{ ps.standort.beschreibung|escapejs|default:'' }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Define CSRF token for AJAX requests
    window.csrfToken = "{{ csrf_token }}";
    window.playlistId = "{{ playlist.id }}";
    window.toggleFavoriteUrl = "{% url 'playlist_toggle_favorite' playlist.id %}";
    window.addCommentUrl = "{% url 'kommentar_hinzufuegen' playlist.id %}";
    window.userProfileUrl = "{% url 'nutzerprofil' user.id %}";
    window.username = "{{ user.username }}";
    {% if user.profilbild %}
    window.userAvatar = "{{ user.profilbild.url }}";
    window.userHasAvatar = true;
    {% else %}
    window.userHasAvatar = false;
    window.userInitial = "{{ user.username|first|upper }}";
    {% endif %}
</script>

<!-- Main JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize components
        initFavoriteButton();
        initMap();
        initCommentForm();
        initSongDurationInput();
    });
    
    // Funktion zur Initialisierung des Dauer-Input-Feldes
    function initSongDurationInput() {
        const songForm = document.querySelector('#addSongModal form');
        if (!songForm) return;
        
        const durationFormat = songForm.querySelector('input[name="dauer_format"]');
        const durationSeconds = songForm.querySelector('#dauer_sekunden');
        
        if (!durationFormat || !durationSeconds) return;
        
        // Beim Absenden des Formulars MM:SS in Sekunden umwandeln
        songForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const durationPattern = /^([0-9]{1,2}):([0-5][0-9])$/;
            const durationValue = durationFormat.value.trim();
            
            if (durationPattern.test(durationValue)) {
                const [minutes, seconds] = durationValue.split(':').map(Number);
                const totalSeconds = (minutes * 60) + seconds;
                durationSeconds.value = totalSeconds;
                
                // Formular absenden
                this.submit();
            } else {
                // Fehler anzeigen
                durationFormat.setCustomValidity('Bitte gib die Dauer im Format MM:SS ein (z.B. 3:45)');
                durationFormat.reportValidity();
            }
        });
        
        // Bei Änderungen im Feld die Validierung zurücksetzen
        durationFormat.addEventListener('input', function() {
            this.setCustomValidity('');
        });
    }
    
    // Initialize favorite button functionality
    function initFavoriteButton() {
        const favoriteBtn = document.getElementById('favorite-btn');
        if (!favoriteBtn) return;
        
        favoriteBtn.addEventListener('click', function() {
            // Show loading state
            const originalContent = favoriteBtn.innerHTML;
            favoriteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            favoriteBtn.disabled = true;
            
            // Send request to toggle favorite status
            fetch(window.toggleFavoriteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': window.csrfToken,
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateFavoriteButton(favoriteBtn, data.is_favorite);
                } else {
                    // Restore original state if server indicates failure
                    favoriteBtn.innerHTML = originalContent;
                    favoriteBtn.disabled = false;
                    showToast('Fehler beim Aktualisieren des Favoriten-Status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Restore original state on error
                favoriteBtn.innerHTML = originalContent;
                favoriteBtn.disabled = false;
                showToast('Fehler bei der Verbindung zum Server');
            });
        });
    }
    
    // Update favorite button based on state
    function updateFavoriteButton(button, isFavorite) {
        button.disabled = false;
        
        // Immer gelb, nur Text ändert sich
        if (isFavorite) {
            button.innerHTML = '<i class="fas fa-star"></i> Favorisiert';
        } else {
            button.innerHTML = '<i class="fas fa-star"></i> Favorisieren';
        }
        
        // Optional: Show success toast
        showToast(isFavorite ? 'Zur Favoritenliste hinzugefügt' : 'Aus Favoritenliste entfernt');
    }
    
    // Show toast notification
    function showToast(message) {
        // Check if Bootstrap toast is available
        if (typeof bootstrap !== 'undefined') {
            // Create toast element
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Add to container or body
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toastEl);
            
            // Show toast
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            // Remove after hiding
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        } else {
            // Fallback if Bootstrap is not available
            console.log('Toast message:', message);
        }
    }
    
    // Initialize map
    function initMap() {
        const mapElement = document.getElementById('playlist-map');
        if (!mapElement) return;
        
        // Get locations from the window object
        const locations = window.playlistLocations || [];
        if (locations.length === 0) return;
        
        try {
            // Initialize Leaflet map
            const map = L.map(mapElement).setView([locations[0].lat, locations[0].lng], 13);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors'
            }).addTo(map);
        
            // Add markers and bounds
            const bounds = L.latLngBounds();
            
            locations.forEach(location => {
                // Add location to bounds
                bounds.extend([location.lat, location.lng]);
                
                // Create custom marker
                const marker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'custom-map-marker',
                        html: '<div class="marker-pin"></div>',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    })
                }).addTo(map);
                
                // Create popup
                let popupContent = '<div class="map-popup">';
                popupContent += '<h3>' + location.name + '</h3>';
                
                if (location.address) {
                    popupContent += '<p>' + location.address + '</p>';
                }
                
                if (location.description) {
                    popupContent += '<p class="popup-description">' + location.description + '</p>';
                }
                
                popupContent += '<p class="popup-coords">' + location.lat.toFixed(6) + ', ' + location.lng.toFixed(6) + '</p>';
                popupContent += '</div>';
                
                marker.bindPopup(popupContent);
            });
            
            // Fit map to bounds if multiple locations
            if (locations.length > 1) {
                map.fitBounds(bounds, {
                    padding: [30, 30]
                });
            }
            
            // Add map styling
            addMapStyles();
        } catch (error) {
            console.error('Error initializing map:', error);
            mapElement.innerHTML = '<div class="map-error"><p>Fehler beim Laden der Karte</p></div>';
        }
    }
    
    // Add map custom styling
    function addMapStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .custom-map-marker {
                background: transparent;
            }
            .marker-pin {
                width: 24px;
                height: 24px;
                border-radius: 50% 50% 50% 0;
                background: var(--primary);
                position: absolute;
                transform: rotate(-45deg);
                left: 50%;
                top: 50%;
                margin: -20px 0 0 -12px;
                box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            }
            .marker-pin::after {
                content: '';
                width: 14px;
                height: 14px;
                margin: 5px 0 0 5px;
                background: white;
                position: absolute;
                border-radius: 50%;
            }
            .map-popup {
                text-align: center;
            }
            .map-popup h3 {
                font-size: 1rem;
                font-weight: 600;
                margin: 0 0 5px 0;
            }
            .map-popup p {
                margin: 5px 0;
                font-size: 0.85rem;
            }
            .popup-description {
                font-style: italic;
                color: #6c757d;
            }
            .popup-coords {
                font-family: monospace;
                font-size: 0.75rem;
                color: #6c757d;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Initialize comment form with AJAX submission
    function initCommentForm() {
        const commentForm = document.getElementById('comment-form');
        const commentsList = document.querySelector('.comments-list');
        
        if (!commentForm || !commentsList) return;
        
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const commentText = document.getElementById('comment-text').value.trim();
            if (!commentText) return;
            
            // Show loading state
            const submitBtn = commentForm.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitBtn.disabled = true;
            
            // Get form data
            const formData = new FormData(commentForm);
            
            // Send AJAX request
            fetch(commentForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Clear the form
                    document.getElementById('comment-text').value = '';
                    
                    // Add the new comment to the list
                    if (commentsList.querySelector('.empty-state')) {
                        // Remove empty state if it exists
                        commentsList.innerHTML = '';
                    }
                    
                    // Create and add the new comment element
                    const newComment = document.createElement('div');
                    newComment.className = 'comment';
                    
                    // Using string concatenation instead of template literals
                    let commentHtml = '<div class="comment-avatar">';
                    commentHtml += data.kommentar.avatar_html;
                    commentHtml += '</div>';
                    commentHtml += '<div class="comment-content">';
                    commentHtml += '<div class="comment-header">';
                    commentHtml += '<a href="' + data.kommentar.nutzer_url + '" class="comment-author">';
                    commentHtml += data.kommentar.nutzer_name;
                    commentHtml += '</a>';
                    commentHtml += '<span class="comment-time">';
                    commentHtml += data.kommentar.datum + ' um ' + data.kommentar.zeit;
                    commentHtml += '</span>';
                    commentHtml += '</div>';
                    commentHtml += '<div class="comment-text">';
                    commentHtml += data.kommentar.text;
                    commentHtml += '</div>';
                    commentHtml += '</div>';
                    
                    newComment.innerHTML = commentHtml;
                    
                    // Add at the top of the list (newest first)
                    commentsList.insertBefore(newComment, commentsList.firstChild);
                    
                    // Show success message
                    showToast('Kommentar erfolgreich hinzugefügt!');
                } else {
                    showToast(data.error || 'Fehler beim Hinzufügen des Kommentars.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Fehler bei der Verbindung zum Server');
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.disabled = false;
            });
        });
    }
</script>
{% endblock %}