{% extends 'geotune/base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ playlist.name }} - GeoTune{% endblock %}

{% block head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'geotune/css/playlist_detail.css' %}">
<!-- Leaflet JS explizit laden -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  // Global variables for JavaScript
  window.csrfToken = "{{ csrf_token }}";
  window.toggleFavoriteUrl = "{% url 'playlist_toggle_favorite' playlist.id %}";
</script>
{% endblock %}

{% block content %}
<div class="playlist-container">
    <!-- Hero Section -->
    <section class="playlist-hero">
        <div class="playlist-hero-content">
            <div class="playlist-title-container">
                <h1 class="playlist-title">{{ playlist.name }}</h1>
                    {% if playlist.ist_oeffentlich %}
                    <span class="playlist-badge public">
                        <i class="fas fa-globe"></i> Öffentlich
                    </span>
                    {% else %}
                    <span class="playlist-badge private">
                        <i class="fas fa-lock"></i> Privat
                    </span>
                    {% endif %}
                </div>
                
            <div class="playlist-meta">
                <div class="playlist-meta-item">
                    <i class="fas fa-user"></i>
                    <a href="{% url 'nutzerprofil' playlist.erstellt_von.id %}">
                        {{ playlist.erstellt_von.username }}
                    </a>
                </div>
                <div class="playlist-meta-item">
                    <i class="far fa-calendar-alt"></i>
                    <span>{{ playlist.erstellungsdatum|date:"d.m.Y" }}</span>
                </div>
                <div class="playlist-meta-item">
                    <i class="fas fa-eye"></i>
                    <span>{{ playlist.anzahl_aufrufe }} Aufrufe</span>
                </div>
                <div class="playlist-meta-item">
                    <i class="fas fa-music"></i>
                    <span>{{ lieder|length }} Lieder</span>
                </div>
            </div>
                
                {% if playlist.beschreibung %}
            <p class="playlist-description">{{ playlist.beschreibung }}</p>
                {% endif %}
                
                {% if playlist.genres.all %}
            <div class="playlist-genres mb-4">
                    {% for genre in playlist.genres.all %}
                <span class="genre-tag">{{ genre.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            
            <div class="hero-actions d-flex align-items-center">
                    {% if playlist.erstellt_von == user %}
                <a href="{% url 'playlist_standort_hinzufuegen' playlist.id %}" class="btn-hero primary me-3" style="margin-right: 12px;">
                    <i class="fas fa-map-marker-alt"></i> Standort hinzufügen
                    </a>
                <a href="{% url 'playlist_bearbeiten' playlist.id %}" class="btn-hero edit me-3" style="margin-right: 12px;">
                    <i class="fas fa-edit"></i> Bearbeiten
                    </a>
                    {% endif %}
                    
                <!-- Favorite Button -->
                <form id="favorite-form" action="{% url 'playlist_toggle_favorite' playlist.id %}" method="post">
                    {% csrf_token %}
                    <button id="favorite-btn" type="submit" class="btn-hero accent">
                        <i class="fas fa-star"></i> 
                        {% if ist_favorit %}Favorisiert{% else %}Favorisieren{% endif %}
                    </button>
                </form>
            </div>
            </div>
    </section>

<!-- Main Content -->
    <div class="content-grid">
        <!-- Left Column -->
        <div class="content-main">
            <!-- Songs Section -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title" style="margin-bottom: 0rem;">
                        <i class="fas fa-music"></i>
                        <h2>Lieder</h2>
                    </div>
                    
                {% if playlist.erstellt_von == user %}
                    <button type="button" class="btn-action" data-bs-toggle="modal" data-bs-target="#addSongModal">
                        <i class="fas fa-plus"></i>
                        <span>Hinzufügen</span>
                </button>
                {% endif %}
            </div>
            
                {% if lieder %}
                <div class="song-list">
                            {% for playlist_lied in lieder %}
                    <div class="song-item">
                        <div class="song-number">{{ forloop.counter }}</div>
                        
                        <div class="song-cover">
                                        {% if playlist_lied.lied.cover_bild %}
                                <img src="{{ playlist_lied.lied.cover_bild }}" alt="Cover von {{ playlist_lied.lied.titel }}">
                                        {% else %}
                                <div class="song-cover-placeholder">
                                    <i class="fas fa-music"></i>
                                            </div>
                                        {% endif %}
                        </div>
                                        
                        <div class="song-info">
                            <div class="song-title">
                                            {% if playlist_lied.lied.externe_url %}
                                <a href="{{ playlist_lied.lied.externe_url }}" target="_blank" rel="noopener">
                                                    {{ playlist_lied.lied.titel }}
                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            {% else %}
                                                {{ playlist_lied.lied.titel }}
                                            {% endif %}
                                        </div>
                            
                            <div class="song-details">
                                <span class="song-artist">{{ playlist_lied.lied.kuenstler }}</span>
                                {% if playlist_lied.lied.album %}
                                <span class="song-album d-none d-md-inline">{{ playlist_lied.lied.album }}</span>
                                {% endif %}
                                <span class="song-added-by d-none d-md-inline">
                                    Hinzugefügt von 
                                    <a href="{% url 'nutzerprofil' playlist_lied.hinzugefuegt_von.id %}">
                                        {{ playlist_lied.hinzugefuegt_von.username }}
                                    </a>
                                </span>
                            </div>
                        </div>
                        
                        <div class="song-duration">
                            {{ playlist_lied.lied.dauer|intdiv:60 }}:{{ playlist_lied.lied.dauer|modulo:60|stringformat:"02d" }}
                        </div>
                        
                        {% if playlist.erstellt_von == user %}
                        <div class="song-actions">
                            <button type="button" class="btn-icon edit-song" data-lied-id="{{ playlist_lied.lied.id }}" title="Lied bearbeiten">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn-icon delete-song" data-lied-id="{{ playlist_lied.lied.id }}" title="Lied löschen">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                            {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-music"></i>
                    </div>
                    <h3>Keine Lieder</h3>
                    <p>Diese Playlist enthält noch keine Lieder.</p>
                    
                    {% if playlist.erstellt_von == user %}
                    <button type="button" class="btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSongModal">
                        <i class="fas fa-plus"></i> Erstes Lied hinzufügen
                    </button>
                    {% endif %}
                </div>
                {% endif %}
        </div>
        
        <!-- Comments Section -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title" style="margin-bottom: 0rem;">
                        <i class="fas fa-comments"></i>
                        <h2>Kommentare</h2>
            </div>
                    </div>
                
                <!-- Comment Form -->
                <div class="comment-form-container">
                    <form id="comment-form" method="post" action="{% url 'kommentar_hinzufuegen' playlist.id %}">
                        {% csrf_token %}
                        <div class="comment-input">
                            <textarea 
                                id="comment-text" 
                                name="text" 
                                placeholder="Schreibe einen Kommentar..."
                                required
                            ></textarea>
                            <button type="submit" class="btn-comment">
                                <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                </div>
                
                <!-- Comments List -->
                <div class="comments-list">
                {% if kommentare %}
                    {% for kommentar in kommentare %}
                        <div class="comment">
                            <div class="comment-avatar">
                            {% if kommentar.nutzer.profilbild %}
                                    <img src="{{ kommentar.nutzer.profilbild.url }}" alt="{{ kommentar.nutzer.username }}">
                            {% else %}
                                    <div class="avatar-placeholder">
                                        {{ kommentar.nutzer.username|first|upper }}
                                </div>
                            {% endif %}
                        </div>
                            
                            <div class="comment-content">
                                <div class="comment-header">
                                    <a href="{% url 'nutzerprofil' kommentar.nutzer.id %}" class="comment-author">
                                        {{ kommentar.nutzer.username }}
                                    </a>
                                    <span class="comment-time">
                                        {{ kommentar.erstellungsdatum|date:"d.m.Y" }} um {{ kommentar.erstellungsdatum|date:"H:i" }}
                                    </span>
                            </div>
                                
                                <div class="comment-text">
                                    {{ kommentar.text }}
                                </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                        <div class="empty-state small">
                            <div class="empty-state-icon">
                                <i class="far fa-comment-dots"></i>
                            </div>
                            <p>Noch keine Kommentare vorhanden.<br>Sei der Erste!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
        <!-- Sidebar -->
        <div class="content-sidebar">
            <!-- Locations Section -->
            <div class="sidebar-section">
                <div class="section-header">
                    <div class="section-title" style="margin-bottom: 0rem;">
                        <i class="fas fa-map-marker-alt"></i>
                        <h2>Standorte</h2>
                    </div>
                </div>
                
                {% if standorte %}
                <div class="map-container" style="height: 400px; width: 100%; margin-bottom: 20px; position: relative; z-index: 1;">
                    <div id="playlist-map" style="height: 100%; width: 100%; border-radius: 8px; overflow: hidden;"></div>
                </div>

                <!-- Leaflet JS -->
                <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

                <!-- Map Initialization Script -->
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Initializing map on DOMContentLoaded');
                    
                    // Prüfen, ob Leaflet geladen ist
                    if (typeof L === 'undefined') {
                        console.error('Leaflet not loaded');
                        return;
                    }
                    
                    // Map-Element prüfen
                    const mapElement = document.getElementById('playlist-map');
                    if (!mapElement) {
                        console.error('Map element not found');
                        return;
                    }
                    
                    try {
                        // Standorte direkt aus Template-Daten laden
                        const locations = [
                            {% for ps in standorte %}
                            {
                                lat: {{ ps.standort.breitengrad|stringformat:"f"|cut:"," }},
                                lng: {{ ps.standort.laengengrad|stringformat:"f"|cut:"," }},
                                name: "{% if ps.standort.stadt or ps.standort.land %}{{ ps.standort.stadt }}{% if ps.standort.stadt and ps.standort.land %}, {% endif %}{{ ps.standort.land }}{% else %}Standort{% endif %}",
                                address: "{{ ps.standort.adresse|default:'' }}",
                                description: "{{ ps.standort.beschreibung|default:'' }}"
                            }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ];
                        
                        if (locations.length === 0) {
                            console.warn('No locations available');
                            return;
                        }
                        
                        // Map initialisieren
                        const map = L.map(mapElement).setView([locations[0].lat, locations[0].lng], 13);
                        
                        // Tile Layer hinzufügen
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }).addTo(map);
                        
                        // Marker hinzufügen
                        const bounds = L.latLngBounds();
                        
                        locations.forEach(function(location) {
                            bounds.extend([location.lat, location.lng]);
                            
                            // Marker erstellen
                            const marker = L.marker([location.lat, location.lng]).addTo(map);
                            
                            // Popup erstellen
                            let popupContent = '<div class="map-popup">';
                            popupContent += '<h3>' + location.name + '</h3>';
                            
                            if (location.address) {
                                popupContent += '<p>' + location.address + '</p>';
                            }
                            
                            if (location.description) {
                                popupContent += '<p class="popup-description">' + location.description + '</p>';
                            }
                            
                            popupContent += '<p class="popup-coords">' + location.lat.toFixed(6) + ', ' + location.lng.toFixed(6) + '</p>';
                            popupContent += '</div>';
                            
                            marker.bindPopup(popupContent);
                        });
                        
                        // Map an alle Marker anpassen
                        if (locations.length > 1) {
                            map.fitBounds(bounds, {
                                padding: [30, 30]
                            });
                        }
                        
                        // Nach einer kurzen Verzögerung die Map aktualisieren
                        setTimeout(function() {
                            map.invalidateSize(true);
                        }, 300);
                        
                    } catch (error) {
                        console.error('Map initialization error:', error);
                    }
                });
                </script>
                
                <div class="location-list">
                        {% for ps in standorte %}
                        <div class="location-item">
                        <div class="location-icon">
                            <i class="fas fa-map-pin"></i>
                        </div>
                        
                        <div class="location-details">
                            <div class="location-name">
                                    {% if ps.standort.stadt or ps.standort.land %}
                                    {{ ps.standort.stadt }}{% if ps.standort.stadt and ps.standort.land %}, {% endif %}{{ ps.standort.land }}
                                {% else %}
                                    Unbenannter Standort
                                    {% endif %}
                            </div>
                                    
                                    {% if ps.standort.adresse %}
                                    <div class="location-address">{{ ps.standort.adresse }}</div>
                                    {% endif %}
                                    
                            <div class="location-coordinates">
                                {{ ps.standort.breitengrad|floatformat:6 }}, {{ ps.standort.laengengrad|floatformat:6 }}
                            </div>
                                    
                                    {% if ps.standort.beschreibung %}
                                    <div class="location-description">
                                        "{{ ps.standort.beschreibung }}"
                                    </div>
                                    {% endif %}
                                </div>
                        
                        <a 
                            href="https://www.google.com/maps/search/?api=1&query={{ ps.standort.breitengrad }},{{ ps.standort.laengengrad }}" 
                            target="_blank" 
                            rel="noopener"
                            class="location-action"
                            title="In Google Maps öffnen"
                        >
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-map-marker-slash"></i>
                        </div>
                    <h3>Keine Standorte</h3>
                    <p>Diese Playlist hat noch keine Standorte.</p>
                    
                        {% if playlist.erstellt_von == user %}
                    <a href="{% url 'playlist_standort_hinzufuegen' playlist.id %}" class="btn-outline-primary">
                        <i class="fas fa-map-marker-alt"></i> Standort hinzufügen
                        </a>
                        {% endif %}
                    </div>
                {% endif %}
        </div>
        
        <!-- Similar Playlists Section -->
        <div class="sidebar-section">
            <div class="section-header">
                <div class="section-title" style="margin-bottom: 0rem;">
                    <i class="fas fa-list-music"></i>
                    <h2>Ähnliche Playlists</h2>
            </div>
                </div>
                
                {% if aehnliche_playlists %}
                <div class="similar-playlists">
                        {% for aehnliche_playlist in aehnliche_playlists %}
                    <a href="{% url 'playlist_detail' aehnliche_playlist.id %}" class="similar-playlist">
                        <div class="similar-playlist-icon">
                                    <i class="fas fa-music"></i>
                                </div>
                        
                        <div class="similar-playlist-info">
                            <div class="similar-playlist-name">
                                {{ aehnliche_playlist.name }}
                            </div>
                            <div class="similar-playlist-meta">
                                    <span>{{ aehnliche_playlist.erstellt_von.username }}</span>
                                <span class="meta-separator"></span>
                                    <span>{{ aehnliche_playlist.lieder.count }} Lieder</span>
                            </div>
                        </div>
                        
                        <div class="similar-playlist-action">
                            <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                <div class="empty-state small">
                    <div class="empty-state-icon">
                        <i class="fas fa-music"></i>
                    </div>
                    <p>Keine ähnlichen Playlists gefunden.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Song Modal -->
{% if playlist.erstellt_von == user %}
<div class="modal fade" id="addSongModal" tabindex="-1" aria-labelledby="addSongModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSongModalLabel">Lied zur Playlist hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <form method="post" id="add-song-form">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="{{ lied_form.titel.id_for_label }}" name="{{ lied_form.titel.html_name }}" placeholder="Titel" required>
                        <label for="{{ lied_form.titel.id_for_label }}">Titel</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="{{ lied_form.kuenstler.id_for_label }}" name="{{ lied_form.kuenstler.html_name }}" placeholder="Künstler" required>
                        <label for="{{ lied_form.kuenstler.id_for_label }}">Künstler</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="{{ lied_form.album.id_for_label }}" name="{{ lied_form.album.html_name }}" placeholder="Album">
                                <label for="{{ lied_form.album.id_for_label }}">Album</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="{{ lied_form.dauer.id_for_label }}" name="dauer_format" placeholder="Dauer (MM:SS)" required pattern="^([0-9]{1,2}):([0-5][0-9])$">
                                <input type="hidden" name="{{ lied_form.dauer.html_name }}" id="dauer_sekunden">
                                <label for="{{ lied_form.dauer.id_for_label }}">Dauer (MM:SS)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="{{ lied_form.externe_url.id_for_label }}" name="{{ lied_form.externe_url.html_name }}" placeholder="Externe URL">
                        <label for="{{ lied_form.externe_url.id_for_label }}">Externe URL</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="{{ lied_form.cover_bild.id_for_label }}" name="{{ lied_form.cover_bild.html_name }}" placeholder="Cover Bild URL">
                        <label for="{{ lied_form.cover_bild.id_for_label }}">Cover Bild URL</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-hero edit" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Abbrechen
                    </button>
                    <button type="submit" class="btn-hero accent" id="add-song-btn">
                        <i class="fas fa-plus"></i> Lied hinzufügen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Song Modal -->
<div class="modal fade" id="editSongModal" tabindex="-1" aria-labelledby="editSongModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSongModalLabel">Lied bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <form method="post" id="edit-song-form">
                {% csrf_token %}
                <input type="hidden" id="edit-lied-id" name="lied_id">
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="edit-titel" name="titel" placeholder="Titel" required>
                        <label for="edit-titel">Titel</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="edit-kuenstler" name="kuenstler" placeholder="Künstler" required>
                        <label for="edit-kuenstler">Künstler</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="edit-album" name="album" placeholder="Album">
                                <label for="edit-album">Album</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="edit-dauer-format" name="dauer_format" placeholder="Dauer (MM:SS)" required pattern="^([0-9]{1,2}):([0-5][0-9])$">
                                <input type="hidden" name="dauer" id="edit-dauer-sekunden">
                                <label for="edit-dauer-format">Dauer (MM:SS)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="edit-externe-url" name="externe_url" placeholder="Externe URL">
                        <label for="edit-externe-url">Externe URL</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="edit-cover-bild" name="cover_bild" placeholder="Cover Bild URL">
                        <label for="edit-cover-bild">Cover Bild URL</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-hero edit" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Abbrechen
                    </button>
                    <button type="submit" class="btn-hero accent" id="edit-song-btn">
                        <i class="fas fa-save"></i> Änderungen speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Song Confirmation Modal -->
<div class="modal fade" id="deleteSongModal" tabindex="-1" aria-labelledby="deleteSongModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSongModalLabel">Lied löschen</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="modal-icon-container me-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                    </div>
                    <div>
                        <p class="mb-1">Möchtest du dieses Lied wirklich aus der Playlist entfernen?</p>
                        <p class="song-title-display text-dark fw-bold mb-0"></p>
                    </div>
                </div>
                <p class="text-muted small">Diese Aktion kann nicht rückgängig gemacht werden.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-hero edit" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
                <button type="button" class="btn-hero danger bg-danger text-white" id="confirm-delete-btn" style="background-color: #dc3545 !important; color: white !important;">
                    <i class="fas fa-trash-alt"></i> Lied löschen
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- First, define locations data so it's accessible to our scripts -->
<script>
    // Define CSRF token for AJAX requests
    window.csrfToken = "{{ csrf_token }}";
    window.playlistId = "{{ playlist.id }}";
    window.toggleFavoriteUrl = "{% url 'playlist_toggle_favorite' playlist.id %}";
    window.addCommentUrl = "{% url 'kommentar_hinzufuegen' playlist.id %}";
    window.userProfileUrl = "{% url 'nutzerprofil' user.id %}";
    window.username = "{{ user.username }}";
    {% if user.profilbild %}
    window.userAvatar = "{{ user.profilbild.url }}";
    window.userHasAvatar = true;
    {% else %}
    window.userHasAvatar = false;
    window.userInitial = "{{ user.username|first|upper }}";
    {% endif %}
</script>

<!-- Main JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Debug log to check if variables are properly set
        console.log('Debug - Window Variables:', {
            csrfToken: window.csrfToken,
            playlistId: window.playlistId,
            toggleFavoriteUrl: window.toggleFavoriteUrl
        });
        
        try {
            // Initialize components that exist
            if (typeof initSongDurationInput === 'function') {
                initSongDurationInput();
            }
            if (typeof initFavoriteButton === 'function') {
                initFavoriteButton();
            }
            if (typeof initCommentForm === 'function') {
                initCommentForm();
            }
            if (typeof initAddSongForm === 'function') {
                initAddSongForm();
            }
            if (typeof initEditSongButtons === 'function') {
                initEditSongButtons();
            }
            if (typeof initDeleteSongButtons === 'function') {
                initDeleteSongButtons();
            }
        } catch (error) {
            console.error('Error initializing page components:', error);
        }
    });
    
    // Global initialization checks
    function elementExists(id) {
        return document.getElementById(id) !== null;
    }
    
    // Funktion zur Initialisierung des Dauer-Input-Feldes
    function initSongDurationInput() {
        const songForm = document.getElementById('add-song-form');
        if (!songForm) return;
        
        const durationFormat = songForm.querySelector('input[name="dauer_format"]');
        const durationSeconds = songForm.querySelector('#dauer_sekunden');
        
        if (!durationFormat || !durationSeconds) return;
        
        // Bei Änderungen im Feld die Validierung zurücksetzen
        durationFormat.addEventListener('input', function() {
            this.setCustomValidity('');
        });
        
        // Gleiche Logik für das Edit-Formular
        const editSongForm = document.getElementById('edit-song-form');
        if (!editSongForm) return;
        
        const editDurationFormat = editSongForm.querySelector('input[name="dauer_format"]');
        const editDurationSeconds = editSongForm.querySelector('#edit-dauer-sekunden');
        
        if (!editDurationFormat || !editDurationSeconds) return;
        
        // Bei Änderungen im Feld die Validierung zurücksetzen
        editDurationFormat.addEventListener('input', function() {
            this.setCustomValidity('');
        });
    }
    
    // Initialize song form with AJAX submission
    function initAddSongForm() {
        const songForm = document.getElementById('add-song-form');
        const songList = document.querySelector('.content-section:first-child .song-list');
        const emptyState = document.querySelector('.content-section:first-child .empty-state');
        const songCount = document.querySelector('.playlist-meta-item .fa-music').parentNode.querySelector('span');
        const addSongModal = document.getElementById('addSongModal');
        
        if (!songForm) return;
        
        songForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Dauer validieren und umwandeln
            const durationFormat = songForm.querySelector('input[name="dauer_format"]');
            const durationSeconds = songForm.querySelector('#dauer_sekunden');
            const durationPattern = /^([0-9]{1,2}):([0-5][0-9])$/;
            const durationValue = durationFormat.value.trim();
            
            if (!durationPattern.test(durationValue)) {
                durationFormat.setCustomValidity('Bitte gib die Dauer im Format MM:SS ein (z.B. 3:45)');
                durationFormat.reportValidity();
                return;
            }
            
            // MM:SS in Sekunden umwandeln
            const [minutes, seconds] = durationValue.split(':').map(Number);
            const totalSeconds = (minutes * 60) + seconds;
            durationSeconds.value = totalSeconds;
            
            // Formular auf allgemeine Gültigkeit prüfen
            if (!songForm.checkValidity()) {
                songForm.reportValidity();
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('add-song-btn');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitBtn.disabled = true;
            
            // Get form data
            const formData = new FormData(songForm);
            
            // Send AJAX request
            fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Create song item HTML with proper formatting
                    const songNumber = songList ? songList.querySelectorAll('.song-item').length + 1 : 1;
                    const minutes = Math.floor(data.lied.dauer / 60);
                    const seconds = data.lied.dauer % 60;
                    const formattedDuration = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    
                    // Create new song element
                    const newSong = document.createElement('div');
                    newSong.className = 'song-item';
                    
                    // Build song item HTML
                    let songHtml = '<div class="song-number">' + songNumber + '</div>';
                    songHtml += '<div class="song-cover">';
                    
                    if (data.lied.cover_bild) {
                        songHtml += '<img src="' + data.lied.cover_bild + '" alt="Cover von ' + data.lied.titel + '">';
                    } else {
                        songHtml += '<div class="song-cover-placeholder"><i class="fas fa-music"></i></div>';
                    }
                    
                    songHtml += '</div>';
                    songHtml += '<div class="song-info">';
                    songHtml += '<div class="song-title">';
                    
                    if (data.lied.externe_url) {
                        songHtml += '<a href="' + data.lied.externe_url + '" target="_blank" rel="noopener">';
                        songHtml += data.lied.titel;
                        songHtml += '<i class="fas fa-external-link-alt"></i>';
                        songHtml += '</a>';
                    } else {
                        songHtml += data.lied.titel;
                    }
                    
                    songHtml += '</div>';
                    songHtml += '<div class="song-details">';
                    songHtml += '<span class="song-artist">' + data.lied.kuenstler + '</span>';
                    
                    if (data.lied.album) {
                        songHtml += '<span class="song-album d-none d-md-inline">' + data.lied.album + '</span>';
                    }
                    
                    songHtml += '<span class="song-added-by d-none d-md-inline">';
                    songHtml += 'Hinzugefügt von <a href="' + window.userProfileUrl + '">' + window.username + '</a>';
                    songHtml += '</span>';
                    songHtml += '</div>';
                    songHtml += '</div>';
                    songHtml += '<div class="song-duration">' + formattedDuration + '</div>';
                    
                    newSong.innerHTML = songHtml;
                    
                    // If empty state exists, replace it with song list
                    if (emptyState) {
                        // Get the songs section container
                        const songsSectionContainer = document.querySelector('.content-section:first-child');
                        
                        // Create new song list
                        const newSongList = document.createElement('div');
                        newSongList.className = 'song-list';
                        newSongList.appendChild(newSong);
                        
                        // Replace empty state with song list
                        songsSectionContainer.removeChild(emptyState);
                        songsSectionContainer.appendChild(newSongList);
                    } else if (songList) {
                        // Add to existing song list
                        songList.appendChild(newSong);
                    }
                    
                    // Update song count in meta information
                    if (songCount) {
                        const currentCount = parseInt(songCount.textContent.split(' ')[0]) || 0;
                        songCount.textContent = (currentCount + 1) + ' Lieder';
                    }
                    
                    // Close the modal
                    const bsModal = bootstrap.Modal.getInstance(addSongModal);
                    bsModal.hide();
                    
                    // Reset form
                    songForm.reset();
                    
                    // Show success message
                    showToast('Lied erfolgreich hinzugefügt!');
                } else {
                    showToast(data.error || 'Fehler beim Hinzufügen des Liedes.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Fehler bei der Verbindung zum Server');
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.disabled = false;
            });
        });
        
        // Event-Listener für Modal-Events hinzufügen
        addSongModal.addEventListener('hidden.bs.modal', function () {
            // Form zurücksetzen wenn Modal geschlossen wird
            songForm.reset();
        });
        
        // Sicherstellen, dass das Modal nach dem Schließen wieder richtig funktioniert
        addSongModal.addEventListener('hidden.bs.modal', function () {
            setTimeout(() => {
                // Eventuelle Dead-Listeners entfernen
                const oldInstance = bootstrap.Modal.getInstance(addSongModal);
                if (oldInstance) {
                    oldInstance.dispose();
                }
            }, 100);
        });
    }
    
    // Initialize edit song buttons and form with AJAX submission
    function initEditSongButtons() {
        const songItems = document.querySelectorAll('.song-item');
        const editSongModal = document.getElementById('editSongModal');
        const editSongForm = document.getElementById('edit-song-form');
        
        if (!songItems.length || !editSongModal || !editSongForm) return;
        
        const editButtons = document.querySelectorAll('.edit-song');
        
        // Event-Listener für Edit-Buttons
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const liedId = this.getAttribute('data-lied-id');
                
                // Visual feedback when button is clicked
                this.classList.add('active');
                const originalContent = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Lied-Daten per AJAX laden
                fetch(`/playlist/${window.playlistId}/lied/${liedId}/bearbeiten/`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Restore button state
                    this.innerHTML = originalContent;
                    this.classList.remove('active');
                    
                    if (data.success) {
                        // Formular mit den Lieddaten befüllen
                        document.getElementById('edit-lied-id').value = data.lied.id;
                        document.getElementById('edit-titel').value = data.lied.titel;
                        document.getElementById('edit-kuenstler').value = data.lied.kuenstler;
                        document.getElementById('edit-album').value = data.lied.album || '';
                        document.getElementById('edit-dauer-format').value = data.lied.dauer_format;
                        document.getElementById('edit-dauer-sekunden').value = data.lied.dauer;
                        document.getElementById('edit-externe-url').value = data.lied.externe_url || '';
                        document.getElementById('edit-cover-bild').value = data.lied.cover_bild || '';
                        
                        // Modal öffnen
                        const bsModal = new bootstrap.Modal(editSongModal);
                        bsModal.show();
                    } else {
                        showToast(data.error || 'Fehler beim Laden der Lieddaten');
                    }
                })
                .catch(error => {
                    // Restore button state on error
                    this.innerHTML = originalContent;
                    this.classList.remove('active');
                    
                    console.error('Error:', error);
                    showToast('Fehler bei der Verbindung zum Server');
                });
            });
        });
        
        // Event-Listener für das Formular
        editSongForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Lied-ID aus dem versteckten Feld holen
            const liedId = document.getElementById('edit-lied-id').value;
            
            // Dauer validieren und umwandeln
            const durationFormat = document.getElementById('edit-dauer-format');
            const durationSeconds = document.getElementById('edit-dauer-sekunden');
            const durationPattern = /^([0-9]{1,2}):([0-5][0-9])$/;
            const durationValue = durationFormat.value.trim();
            
            if (!durationPattern.test(durationValue)) {
                durationFormat.setCustomValidity('Bitte gib die Dauer im Format MM:SS ein (z.B. 3:45)');
                durationFormat.reportValidity();
                return;
            }
            
            // MM:SS in Sekunden umwandeln
            const [minutes, seconds] = durationValue.split(':').map(Number);
            const totalSeconds = (minutes * 60) + seconds;
            durationSeconds.value = totalSeconds;
            
            // Formular auf allgemeine Gültigkeit prüfen
            if (!editSongForm.checkValidity()) {
                editSongForm.reportValidity();
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('edit-song-btn');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitBtn.disabled = true;
            
            // Get form data
            const formData = new FormData(editSongForm);
            
            // Send AJAX request
            fetch(`/playlist/${window.playlistId}/lied/${liedId}/bearbeiten/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Aktualisiere das Lied in der Liste
                    updateSongInList(liedId, data.lied);
                    
                    // Close the modal
                    const bsModal = bootstrap.Modal.getInstance(editSongModal);
                    bsModal.hide();
                    
                    // Reset form
                    editSongForm.reset();
                    
                    // Show success message
                    showToast(data.message || 'Lied erfolgreich aktualisiert!');
                } else {
                    showToast(data.error || 'Fehler beim Aktualisieren des Liedes.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Fehler bei der Verbindung zum Server');
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.disabled = false;
            });
        });
        
        // Event-Listener für Modal-Events hinzufügen
        editSongModal.addEventListener('hidden.bs.modal', function () {
            // Form zurücksetzen wenn Modal geschlossen wird
            editSongForm.reset();
        });
    }
    
    // Helper-Funktion zum Aktualisieren eines Liedes in der Liste
    function updateSongInList(liedId, liedData) {
        // Finde das Lied-Element in der Liste
        const songItem = document.querySelector(`.song-item .edit-song[data-lied-id="${liedId}"]`).closest('.song-item');
        if (!songItem) return;
        
        // Aktualisiere die Lieddaten im DOM
        const titleElement = songItem.querySelector('.song-title');
        const artistElement = songItem.querySelector('.song-artist');
        const albumElement = songItem.querySelector('.song-album');
        const durationElement = songItem.querySelector('.song-duration');
        
        if (titleElement) {
            if (liedData.externe_url) {
                titleElement.innerHTML = `<a href="${liedData.externe_url}" target="_blank" rel="noopener">${liedData.titel}<i class="fas fa-external-link-alt"></i></a>`;
            } else {
                titleElement.textContent = liedData.titel;
            }
        }
        
        if (artistElement) {
            artistElement.textContent = liedData.kuenstler;
        }
        
        if (albumElement && liedData.album) {
            albumElement.textContent = liedData.album;
        }
        
        if (durationElement) {
            const minutes = Math.floor(liedData.dauer / 60);
            const seconds = liedData.dauer % 60;
            durationElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        // Aktualisiere Cover-Bild, falls vorhanden
        const coverElement = songItem.querySelector('.song-cover');
        if (coverElement) {
            if (liedData.cover_bild) {
                coverElement.innerHTML = `<img src="${liedData.cover_bild}" alt="Cover von ${liedData.titel}">`;
            } else {
                coverElement.innerHTML = '<div class="song-cover-placeholder"><i class="fas fa-music"></i></div>';
            }
        }
    }
    
    // Initialize delete song buttons with confirmation and AJAX
    function initDeleteSongButtons() {
        const deleteButtons = document.querySelectorAll('.delete-song');
        const deleteModal = document.getElementById('deleteSongModal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        if (!deleteButtons.length || !deleteModal || !confirmDeleteBtn) return;
        
        // Initialize the Bootstrap modal
        const bsDeleteModal = new bootstrap.Modal(deleteModal);
        
        // Event handler for delete buttons
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const liedId = this.getAttribute('data-lied-id');
                const songItem = this.closest('.song-item');
                const songTitle = songItem.querySelector('.song-title').textContent.trim();
                
                // Set the song title in the modal
                deleteModal.querySelector('.song-title-display').textContent = songTitle;
                
                // Store the liedId and button reference on the modal for later use
                deleteModal.setAttribute('data-lied-id', liedId);
                deleteModal.setAttribute('data-button-id', this.getAttribute('data-lied-id'));
                
                // Show the modal
                bsDeleteModal.show();
            });
        });
        
        // Event handler for the confirm delete button
        confirmDeleteBtn.addEventListener('click', function() {
            // Get the stored liedId and find the original button
            const liedId = deleteModal.getAttribute('data-lied-id');
            const originalButton = document.querySelector(`.delete-song[data-lied-id="${liedId}"]`);
            const songItem = originalButton.closest('.song-item');
            
            // Hide the modal
            bsDeleteModal.hide();
            
            // Visual feedback during deletion
            originalButton.classList.add('active');
            originalButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            songItem.classList.add('deleting');
            
            // FormData mit CSRF-Token erstellen
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', window.csrfToken);
            
            // AJAX-Anfrage zum Löschen des Liedes
            fetch(`/playlist/${window.playlistId}/lied/${liedId}/loeschen/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Smooth fade-out animation
                    songItem.style.transition = 'all 0.3s ease';
                    songItem.style.maxHeight = '0';
                    songItem.style.opacity = '0';
                    
                    setTimeout(() => {
                        // Lied aus der Liste entfernen
                        const songList = document.querySelector('.song-list');
                        songItem.remove();
                        
                        // Überprüfen, ob die Liste jetzt leer ist
                        if (songList && !songList.querySelector('.song-item')) {
                            // Leere Liste durch Empty-State ersetzen
                            const songSection = songList.closest('.content-section');
                            songList.remove();
                            
                            // Empty-State-HTML erstellen
                            const emptyState = document.createElement('div');
                            emptyState.className = 'empty-state';
                            emptyState.innerHTML = `
                                <div class="empty-state-icon">
                                    <i class="fas fa-music"></i>
                                </div>
                                <h3>Keine Lieder</h3>
                                <p>Diese Playlist enthält noch keine Lieder.</p>
                                
                                <button type="button" class="btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSongModal">
                                    <i class="fas fa-plus"></i> Erstes Lied hinzufügen
                                </button>
                            `;
                            
                            songSection.appendChild(emptyState);
                        } else {
                            // Song-Nummern aktualisieren
                            const remainingSongs = document.querySelectorAll('.song-item');
                            remainingSongs.forEach((song, index) => {
                                const numberElement = song.querySelector('.song-number');
                                if (numberElement) {
                                    numberElement.textContent = (index + 1).toString();
                                }
                            });
                        }
                        
                        // Song-Zähler in der Playlist-Meta aktualisieren
                        const songCount = document.querySelector('.playlist-meta-item .fa-music').parentNode.querySelector('span');
                        if (songCount) {
                            const currentCount = parseInt(songCount.textContent.split(' ')[0]) || 0;
                            songCount.textContent = (currentCount - 1) + ' Lieder';
                        }
                    }, 300);
                    
                    // Erfolgsmeldung anzeigen
                    showToast(data.message || 'Lied erfolgreich aus der Playlist entfernt!');
                } else {
                    // Restore item state on error
                    originalButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    originalButton.classList.remove('active');
                    songItem.classList.remove('deleting');
                    showToast(data.error || 'Fehler beim Entfernen des Liedes.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Restore item state on error
                originalButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                originalButton.classList.remove('active');
                songItem.classList.remove('deleting');
                showToast('Fehler bei der Verbindung zum Server');
            });
        });
    }
    
    // Initialize comment form with AJAX submission
    function initCommentForm() {
        const commentForm = document.getElementById('comment-form');
        const commentsList = document.querySelector('.comments-list');
        
        if (!commentForm || !commentsList) return;
        
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const commentText = document.getElementById('comment-text').value.trim();
            if (!commentText) return;
            
            // Show loading state
            const submitBtn = commentForm.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitBtn.disabled = true;
            
            // Get form data
            const formData = new FormData(commentForm);
            
            // Send AJAX request
            fetch(commentForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Clear the form
                    document.getElementById('comment-text').value = '';
                    
                    // Add the new comment to the list
                    if (commentsList.querySelector('.empty-state')) {
                        // Remove empty state if it exists
                        commentsList.innerHTML = '';
                    }
                    
                    // Create and add the new comment element
                    const newComment = document.createElement('div');
                    newComment.className = 'comment';
                    
                    // Using string concatenation instead of template literals
                    let commentHtml = '<div class="comment-avatar">';
                    commentHtml += data.kommentar.avatar_html;
                    commentHtml += '</div>';
                    commentHtml += '<div class="comment-content">';
                    commentHtml += '<div class="comment-header">';
                    commentHtml += '<a href="' + data.kommentar.nutzer_url + '" class="comment-author">';
                    commentHtml += data.kommentar.nutzer_name;
                    commentHtml += '</a>';
                    commentHtml += '<span class="comment-time">';
                    commentHtml += data.kommentar.datum + ' um ' + data.kommentar.zeit;
                    commentHtml += '</span>';
                    commentHtml += '</div>';
                    commentHtml += '<div class="comment-text">';
                    commentHtml += data.kommentar.text;
                    commentHtml += '</div>';
                    commentHtml += '</div>';
                    
                    newComment.innerHTML = commentHtml;
                    
                    // Add at the top of the list (newest first)
                    commentsList.insertBefore(newComment, commentsList.firstChild);
                    
                    // Show success message
                    showToast('Kommentar erfolgreich hinzugefügt!');
                } else {
                    showToast(data.error || 'Fehler beim Hinzufügen des Kommentars.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Fehler bei der Verbindung zum Server');
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Show toast notification
    function showToast(message) {
        // Check if Bootstrap toast is available
        if (typeof bootstrap !== 'undefined') {
            // Create toast element
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Add to container or body
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toastEl);
            
            // Show toast
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            // Remove after hiding
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        } else {
            // Fallback if Bootstrap is not available
            console.log('Toast message:', message);
        }
    }

    // Funktion zum Initialisieren des Favoriten-Buttons
    function initFavoriteButton() {
        const favoriteForm = document.getElementById('favorite-form');
        const favoriteBtn = document.getElementById('favorite-btn');
        
        if (!favoriteForm || !favoriteBtn) return;
        
        // Ursprünglichen Zustand speichern
        const originalState = {
            isFavorited: favoriteBtn.innerHTML.includes('Favorisiert'),
            content: favoriteBtn.innerHTML
        };
        
        favoriteForm.addEventListener('submit', function(e) {
            // Standard-Formular-Absenden verhindern
            e.preventDefault();
            
            // Lade-Status anzeigen
            favoriteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            favoriteBtn.disabled = true;
            
            // FormData-Objekt erstellen
            const formData = new FormData(favoriteForm);
            
            // URL aus dem Formular-Action-Attribut holen
            const url = favoriteForm.getAttribute('action');
            
            // AJAX-Anfrage senden
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: formData
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // Button-Status aktualisieren
                    favoriteBtn.disabled = false;
                    favoriteBtn.innerHTML = data.is_favorite ? 
                        '<i class="fas fa-star"></i> Favorisiert' : 
                        '<i class="fas fa-star"></i> Favorisieren';
                    
                    // Toast-Nachricht anzeigen
                    showToast(data.message);
                } else {
                    // Ursprünglichen Zustand wiederherstellen
                    favoriteBtn.innerHTML = originalState.content;
                    favoriteBtn.disabled = false;
                    showToast('Fehler beim Aktualisieren des Favoriten-Status');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                // Ursprünglichen Zustand wiederherstellen
                favoriteBtn.innerHTML = originalState.content;
                favoriteBtn.disabled = false;
                showToast('Fehler bei der Verbindung zum Server');
            });
        });
    }
</script>
{% endblock %}